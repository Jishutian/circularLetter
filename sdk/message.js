var StropheAll=require("./libs/strophe");(function(){function e(t){if(!(this instanceof e))return new e(t);this.msg=t}var t=require("./utils").utils,i=function(e,t){return this instanceof i?(this._msg={},"function"==typeof i[e]&&(i[e].prototype.setGroup=this.setGroup,this._msg=new i[e](t)),this._msg):new i(e)};i.prototype.setGroup=function(e){this.body.group=e},i.read=function(e){this.id=e,this.type="read"},i.read.prototype.set=function(e){this.body={ackId:e.id,to:e.to}},i.txt=function(e){this.id=e,this.type="txt",this.body={}},i.txt.prototype.set=function(e){this.value=e.msg,this.body={id:this.id,from:e.from,to:e.to,msg:this.value,type:this.type,roomType:e.roomType,chatType:e.chatType,ext:e.ext||{},success:e.success,fail:e.fail},!e.roomType&&delete this.body.roomType},i.cmd=function(e){this.id=e,this.type="cmd",this.body={}},i.cmd.prototype.set=function(e){this.value="",this.body={to:e.to,from:e.from,action:e.action,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{}},!e.roomType&&delete this.body.roomType},i.location=function(e){this.id=e,this.type="loc",this.body={}},i.location.prototype.set=function(e){this.body={to:e.to,from:e.from,type:this.type,roomType:e.roomType,addr:e.addr,lat:e.lat,lng:e.lng,chatType:e.chatType,ext:e.ext||{}}},i.img=function(e){this.id=e,this.type="img",this.body={}},i.img.prototype.set=function(e){this.value=e.file,this.body={id:this.id,file:this.value,apiUrl:e.apiUrl,to:e.to,from:e.from,type:this.type,ext:e.ext||{},roomType:e.roomType,onFileUploadError:e.onFileUploadError,onFileUploadComplete:e.onFileUploadComplete,success:e.success,fail:e.fail,flashUpload:e.flashUpload,width:e.width,height:e.height,body:e.body},!e.roomType&&delete this.body.roomType},i.audio=function(e){this.id=e,this.type="audio",this.body={}},i.audio.prototype.set=function(e){e.file=e.file||t.getFileUrl(e.fileInputId),this.value=e.file,this.filename=e.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:e.apiUrl,to:e.to,from:e.from,type:this.type,ext:e.ext||{},length:e.length||0,roomType:e.roomType,file_length:e.file_length,onFileUploadError:e.onFileUploadError,onFileUploadComplete:e.onFileUploadComplete,success:e.success,fail:e.fail,flashUpload:e.flashUpload,body:e.body},!e.roomType&&delete this.body.roomType},i.file=function(e){this.id=e,this.type="file",this.body={}},i.file.prototype.set=function(e){e.file=e.file||t.getFileUrl(e.fileInputId),this.value=e.file,this.filename=e.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:e.apiUrl,to:e.to,from:e.from,type:this.type,ext:e.ext||{},roomType:e.roomType,onFileUploadError:e.onFileUploadError,onFileUploadComplete:e.onFileUploadComplete,success:e.success,fail:e.fail,flashUpload:e.flashUpload,body:e.body},!e.roomType&&delete this.body.roomType},i.video=function(e){this.id=e,this.type="file",this.body={}},i.video.prototype.set=function(e){e.file=e.file||t.getFileUrl(e.fileInputId),this.value=e.file,this.filename=e.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:e.apiUrl,to:e.to,from:e.from,type:this.type,ext:e.ext||{},roomType:e.roomType,onFileUploadError:e.onFileUploadError,onFileUploadComplete:e.onFileUploadComplete,success:e.success,fail:e.fail,flashUpload:e.flashUpload,body:e.body},!e.roomType&&delete this.body.roomType},e.prototype.send=function(e){var i=this,o=function(i){i.ext=i.ext||{},i.ext.weichat=i.ext.weichat||{},i.ext.weichat.originType=i.ext.weichat.originType||"webim";let o={from:e.context.userId||"",to:i.to,bodies:[i.body],ext:i.ext||{}},l=t.stringify(o),s=StropheAll.$msg({type:i.group||"chat",to:i.toJid,id:i.id,xmlns:"jabber:client"}).c("body").t(l);if(i.roomType&&s.up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"}),i.bodyId){s=StropheAll.$msg({from:e.context.jid||"",to:i.toJid,id:i.id,xmlns:"jabber:client"}).c("body").t(i.bodyId);let t={xmlns:"urn:xmpp:receipts",id:i.bodyId};s.up().c("delivery",t)}if(i.ackId){if(e.context.jid.indexOf(i.toJid)>=0)return;s=StropheAll.$msg({from:e.context.jid||"",to:i.toJid,id:i.id,xmlns:"jabber:client"}).c("body").t(i.ackId);let t={xmlns:"urn:xmpp:receipts",id:i.ackId};s.up().c("acked",t)}e.sendCommand(s.tree(),i.id)};if(i.msg.file){if(i.msg.body&&i.msg.body.url)return void o(i.msg);let l=i.msg.onFileUploadComplete,s=function(e){if(e.entities[0]["file-metadata"]){let t=e.entities[0]["file-metadata"]["content-length"];i.msg.file_length=t,i.msg.filetype=e.entities[0]["file-metadata"]["content-type"],t>204800&&(i.msg.thumbnail=!0)}i.msg.body={type:i.msg.type||"file",url:e.uri+"/"+e.entities[0].uuid,secret:e.entities[0]["share-secret"],filename:i.msg.file.filename||i.msg.filename,size:{width:i.msg.width||0,height:i.msg.height||0},length:i.msg.length||0,file_length:i.msg.file_length||0,filetype:i.msg.filetype},o(i.msg),l instanceof Function&&l(e,i.msg.id)};i.msg.onFileUploadComplete=s,t.uploadFile.call(e,i.msg)}else"img"===i.msg.type?o(i.msg):(i.msg.body={type:"chat"===i.msg.type?"txt":i.msg.type,msg:i.msg.msg},"cmd"===i.msg.type?i.msg.body.action=i.msg.action:"loc"===i.msg.type&&(i.msg.body.addr=i.msg.addr,i.msg.body.lat=i.msg.lat,i.msg.body.lng=i.msg.lng),o(i.msg))},exports._msg=e,exports.message=i})();